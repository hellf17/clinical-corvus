# Clinical Corvus Development Plan

## Notes
- The platform's vision is to act as a "Co-piloto Clínico" for doctors and empower patients, with full Portuguese localization, robust privacy/security (LGPD/HIPAA compliance), and a seamless, modern UI/UX. - i.e. like Cursor for doctors
- The evidence-based medicine module (including deep research) is a core feature, with unified API architecture, advanced deduplication/quality analysis (CiteSource), and centralized backend translation.
- All research and educational flows must be fully translated for the user; backend translation is now centralized and robust.
- Strategic priorities: migration to next-gen AI frameworks (Langroid, Marker), implementation of Knowledge Graph (KG) and Active Learning (AL), robust error handling, and compliance.
- Previously, higher quality sources (e.g., PubMed, renowned international medical libraries) were found before cite source structure changes.
- Relevant files and components: README.md, baml_src, evidence-based-medicine, DeepResearchComponent.tsx, simple_autonomous_research.py, cite_source_service.py, cite_source_visualization.py, europe_pmc_service.py, lens_scholar_service.py, synthesis_helper_service.py, unified_metrics_service.py, unified_pubmed_service.py.
- System now retrieves some reputable international sources (e.g., PubMed, AHA/ESC guidelines), but domain whitelist still filters out some reputable sources; further whitelist/domain/source logic improvements may be necessary.
- New critical issue: Domain whitelist is too restrictive, filtering out reputable sources (e.g., PubMed, NEJM, Medscape, SCCM). Must investigate and expand trusted domains whitelist to improve research quality and include international sources.
- TRUSTED_DOMAIN_WHITELIST expanded to include sccm.org, emcrit.org, atm.amegroups.org, journals.lww.com, tadeclinicagem.com.br, karger.com, thieme-connect.com, tandfonline.com, sciencedirect.com, and others.
- Despite broadening the PubMed query strategy and updating the BAML prompt, PubMed still returns only one or zero results for complex clinical queries. ExtractPubMedKeywords simplification logic is confirmed to be preserving MeSH terms and avoiding overly restrictive filters, but the underlying issue persists. Further investigation into PubMed search logic or fallback strategies is required.
- Identified that PubMed API requests are limited by `max_results` (retmax), which is set via the SearchParameters object in BAML strategies. The default is 5, which severely limits recall even for good queries. Next step: update BAML prompt to set `max_results` to 20–25 for PubMed strategies.
- Backend now respects `max_results` for all PubMed search tiers, fixing a major recall issue in fallback scenarios.
- Data sent to the synthesis LLM is now optimized: full text content is stripped, reducing token usage and improving efficiency.
- Frontend (DeepResearchComponent.tsx) is being overhauled to support the richer research output structure from the backend.
- Recent TypeScript errors indicate mismatches between the frontend interfaces (e.g., KeyFinding, ResearchMetrics) and backend payloads. All optional fields must be handled robustly and interfaces updated to match backend data.
- All Object.entries calls on possibly-undefined objects should use a fallback (|| {}).
- JSX blocks referencing missing fields or with stray tokens must be fixed.
- Root cause of recent TS lint error was an extraneous '}' instead of ')', now fixed; all TypeScript and lint errors are resolved.
- Translation architecture update: DeepL must be used as the primary translation engine, with BAML as a fallback, for all translation flows.
- Implemented: backend translation service (translator_service.py) with DeepL primary and BAML fallback. All translation logic is now centralized and robust.
- All user-facing responses in research endpoints are now translated to Portuguese via translator_service.translate before returning, ensuring consistent localization.
- Implemented: backend translation service (translator_service.py) with DeepL primary and BAML fallback. All translation logic is now centralized and robust.
- All affected frontend API route files have been refactored to remove translation logic and proxy to backend endpoints. Translation is now handled entirely in the backend.
- Translation architecture update: Implemented robust translation system with DeepL as primary engine and BAML as fallback. Fixed batch translation issues that were causing DeepL API 400 Bad Request errors by processing each text item individually.
- Created dedicated FastAPI router (translator_router.py) exposing translation endpoints for TranslateToEnglish and TranslateToPortuguese, resolving 404 Not Found errors for BAML fallback translation.
- Fixed Docker service naming issues in docker-compose.dev.yml by renaming backend service to 'backend-api' and updating all frontend references, resolving ENOTFOUND backend-api hostname resolution errors.
- Refactored research-assistant/autonomous-translated/route.ts to remove obsolete translation logic and ensure pure backend proxying, resolving TypeScript/lint errors.
- Next.js build passes with no translation/module errors after refactor.
- Both `critique-reasoning-path-translated/route.ts` and `assist-identifying-cognitive-biases-scenario-translated/route.ts` have now been refactored to remove all obsolete translation logic, validation, and unreachable code, leaving only the correct proxy logic and type definitions.
- User deleted redundant files from `dr-corvus` and moved the `insights` route to `clinical-assistant`.
- Need to ensure `insights/route.ts` is correctly adjusted for its new location and proxies to the backend as expected.
- Several API route files still import or reference `@/lib/translation`, causing build failures; these must be refactored to use backend proxy logic only.
- The following routes still contain `@/lib/translation` imports and frontend translation logic, and must be refactored to use backend proxy logic only: 
  - clinical-assistant/illness-script-translated/route.ts
  - clinical-assistant/provide-feedback-on-problem-representation-translated/route.ts
  - clinical-assistant/quick-diagnosis-translated/route.ts
  - research-assistant/analyze-pdf-translated/route.ts
  - research-assistant/appraise-evidence-translated/route.ts
- The final vision for Clinical Corvus platform is to provide Dr. Corvus the necessary tools to provide the best possible assistance to their users and patients. Dr. Corvus will use the latest research to provide recommendations and insights to user and possibly monitoring their patient's evolution.

## Task List
- [x] Review README.md to understand app structure and intended deep research behavior
- [x] Investigate current deep research implementation and source selection logic
- [x] Compare current and previous source selection logic (pre/post cite source changes)
- [x] Identify why only Portuguese sources are being found
- [x] Ensure integration with international and reputable sources (e.g., PubMed)
- [x] Investigate and implement correct Europe PMC language filter syntax
- [x] Update europe_pmc_service.py to include English filter
- [x] Review and verify language handling for Brave and Lens.org sources
- [x] Update lens_scholar_service.py to include English filter
- [x] Implement and verify Brave Search English filtering (add `search_lang='en'` to API call)
- [x] Reintroduce calculation and passing of `search_duration_seconds` to metrics in success path of `conduct_autonomous_research` (simple_autonomous_research.py)
- [x] Fix NameError for `strategies` and skip Lens.org strategies in simple_autonomous_research.py
- [x] Fix reference to TARGET_RESULT_COUNT_FOR_BREAK (use self.TARGET_RESULT_COUNT_FOR_BREAK)
- [x] Fix double PubMed language filter bug in unified_pubmed_service.py
- [x] Fix PubMed result conversion in _execute_search_strategy with robust error handling and logging
- [x] Fix import path for UnifiedSearchResult in research_assistant_router.py
- [x] Handle case where all results are filtered out: return a valid SynthesizedResearchOutput with empty/default values instead of raising validation errors
- [x] Investigate and expand trusted domains whitelist to include reputable international sources (PubMed, NEJM, Medscape, SCCM, etc.)
- [x] Test thoroughly with different queries, checking for reputable international sources
- [x] Analyze and improve PubMed query generation logic
- [x] Debug and adjust PubMed search logic to further increase recall (relax MeSH/Publication Type constraints, adjust fallback, or investigate API limitations)
- [x] Ensure BAML prompt sets `max_results` to 20–25 for PubMed SearchParameters
- [x] Propose and implement further fixes to improve source quality and diversity if needed
- [x] Fix PubMed query filter syntax in simple_autonomous_research.py (_execute_search_strategy) via BAML prompt change
- [x] Implement robust Tier 3 PubMed fallback using only Patient and Intervention (P+I) from PICO.
- [x] Restore or reimplement `_translate_query_to_english` method in SimpleAutonomousResearchService
- [x] Fix SynthesizedResearchOutput missing search_duration_seconds attribute error
- [x] Fix NameError: name 'log_research_metrics' is not defined in simple_autonomous_research.py
- [x] Fix PubMed Tier 3 fallback to respect `max_results` parameter
- [x] Optimize data sent to synthesis LLM by stripping full content
- [x] Update frontend interfaces and rendering logic to match new research output
- [x] Validate frontend UI with new backend data and test thoroughly
- [x] Align frontend interfaces with backend payloads and fix TS errors
- [x] Restore or refactor '@/lib/translation' module or update imports in affected API route files to resolve build error
- [x] Implement backend translation service (translator_service.py) with DeepL primary + BAML fallback
- [x] Refactor translation logic to use DeepL as primary and BAML as fallback in both backend (deepl_client.py) and BAML (translator.baml)
- [x] Refactor all backend translation calls to use translator_service.translate instead of direct DeepL/BAML calls
- [x] Refactor all affected frontend API route files to remove '@/lib/translation' imports and translation logic, and proxy to backend endpoints
- [x] Refactor and clean up critique-reasoning-path-translated/route.ts and assist-identifying-cognitive-biases-scenario-translated/route.ts to remove obsolete translation logic and unreachable code
- [x] Verify Next.js build passes after refactor
- [x] Review and adjust new `clinical-assistant/insights/route.ts` for correct proxying and endpoint naming
- [x] Refactor all remaining API routes to remove `@/lib/translation` imports and obsolete translation logic, replacing with backend proxy logic
  - [x] Refactor clinical-assistant/analyze-differential-diagnosis-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/answer-probe-questions-snapps-translated/route.ts to use backend proxy logic
    - [x] Refactor clinical-assistant/assist-identifying-cognitive-biases-scenario-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/critique-reasoning-path-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/evaluate-management-plan-snapps-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/evaluate-summary-snapps-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/facilitate-ddx-analysis-snapps-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/generate-diagnostic-timeout-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/generate-differential-diagnosis-questions-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/illness-script-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/provide-feedback-on-problem-representation-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/quick-diagnosis-translated/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/insights/route.ts to use backend proxy logic
  - [x] Refactor clinical-assistant/provide-session-summary-snapps-translated/route.ts to use backend proxy logic
  - [x] Refactor research-assistant/analyze-pdf-translated/route.ts to use backend proxy logic
  - [x] Refactor research-assistant/appraise-evidence-translated/route.ts to use backend proxy logic
  - [x] Refactor research-assistant/autonomous-translated/route.ts to use backend proxy logic
  - [x] Refactor research-assistant/generate-pico-question-translated/route.ts to use backend proxy logic
- [ ] Finalize Deep Research and other Clinical Academy features in 'frontend/src/app/academy' and other related files
  - [ ] Ensure all deep research features are working as expected
  - [ ] Ensure other Clinical Academy features are working as expected
    - [ ] Raciocinio Diagnostico 
    - [ ] Diagnostico Diferencial
    - [ ] MBE    
    - [ ] Metacognição
    - [ ] SNAAPS
- [ ] Finalize Analysis and Insights features in 'frontend/src/app/analysis' and other related files
- [ ] Develop doctor dashboard with patients page
- [ ] Implement safety measures for all API flows
- [ ] Implement DB, Vectors and KG storage
- [ ] Migrate core AI frameworks to Langroid and Marker (see README)
- [ ] Implement autonomous agent for research module with access to all research features
  - [ ] Implement robust logging with cryptographic signatures for agent actions
- [ ] Plan and begin implementation of Knowledge Graph (KG) and Active Learning (AL) for clinical reasoning and research modules
- [ ] Investigate and plan integration of Ritual decentralized AI architecture
- [ ] Continue UI/UX modernization and accessibility improvements across modules
- [ ] Continue rigorous compliance review (LGPD/HIPAA) and privacy/security audits
- [ ] Add Deep Research storage/mapping/retrieval to KG, DB and Vectors
- [ ] Implement Gamification features
## Current Goal
Finalize Clinical Academy features, ensure robust translation across all platform features
Finalize Analysis and Insights features
